<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GuavaGuard ASI Edition ‚Äî Activate</title>
<style>
  :root { --bg:#0a0a0f; --surface:#12121a; --border:#1e1e2e; --primary:#00ff88; --primary-dim:#00cc6a; --danger:#ff4466; --text:#e0e0e0; --text-dim:#888; --guava:#f4a460; }
  * { margin:0; padding:0; box-sizing:border-box; }
  body { font-family:'SF Mono','Fira Code','Consolas',monospace; background:var(--bg); color:var(--text); min-height:100vh; display:flex; align-items:center; justify-content:center; padding:20px; }
  .container { max-width:520px; width:100%; background:var(--surface); border:1px solid var(--border); border-radius:16px; padding:40px; box-shadow:0 0 60px rgba(0,255,136,0.05); }
  .logo { text-align:center; font-size:48px; margin-bottom:8px; }
  h1 { text-align:center; font-size:20px; color:var(--primary); margin-bottom:4px; letter-spacing:2px; }
  .subtitle { text-align:center; color:var(--text-dim); font-size:12px; margin-bottom:12px; }
  .security-banner { text-align:center; font-size:10px; color:var(--text-dim); background:rgba(0,255,136,0.03); border:1px solid var(--border); border-radius:8px; padding:8px; margin-bottom:24px; line-height:1.6; }
  .security-banner strong { color:var(--primary); }
  .contract-info { font-size:10px; color:var(--text-dim); background:rgba(244,164,96,0.05); border:1px solid var(--border); border-radius:8px; padding:10px; margin-bottom:20px; word-break:break-all; line-height:1.8; }
  .contract-info code { color:var(--guava); }
  .step { background:rgba(0,255,136,0.03); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:16px; transition:border-color 0.3s; }
  .step.active { border-color:var(--primary); }
  .step.done { border-color:var(--primary-dim); opacity:0.6; }
  .step-header { display:flex; align-items:center; gap:10px; margin-bottom:10px; }
  .step-num { width:28px; height:28px; border-radius:50%; background:var(--border); display:flex; align-items:center; justify-content:center; font-size:13px; font-weight:bold; color:var(--text-dim); }
  .step.active .step-num { background:var(--primary); color:var(--bg); }
  .step.done .step-num { background:var(--primary-dim); color:var(--bg); }
  .step-title { font-size:14px; font-weight:600; }
  .step-desc { font-size:12px; color:var(--text-dim); line-height:1.6; }
  .input-group { margin-top:12px; }
  .input-group label { display:block; font-size:11px; color:var(--text-dim); margin-bottom:4px; }
  .input-group input { width:100%; padding:10px 12px; background:var(--bg); border:1px solid var(--border); border-radius:8px; color:var(--text); font-family:inherit; font-size:13px; outline:none; }
  .input-group input:focus { border-color:var(--primary); }
  button.action-btn { width:100%; padding:14px; border:none; border-radius:10px; font-family:inherit; font-size:14px; font-weight:700; cursor:pointer; transition:all 0.2s; margin-top:12px; letter-spacing:1px; }
  button.action-btn:disabled { opacity:0.4; cursor:not-allowed; }
  .btn-connect { background:linear-gradient(135deg,#6366f1,#8b5cf6); color:#fff; }
  .btn-approve { background:linear-gradient(135deg,var(--guava),#e08830); color:var(--bg); }
  .btn-register { background:linear-gradient(135deg,var(--primary),#00cc6a); color:var(--bg); }
  button:hover:not(:disabled) { filter:brightness(1.1); }
  .status { text-align:center; font-size:12px; padding:8px; margin-top:8px; border-radius:8px; }
  .status.info { color:var(--primary); background:rgba(0,255,136,0.05); }
  .status.error { color:var(--danger); background:rgba(255,68,102,0.05); }
  .status.success { color:var(--primary); background:rgba(0,255,136,0.1); }
  .wallet-info { font-size:11px; color:var(--text-dim); text-align:center; margin-top:4px; word-break:break-all; }
  .footer { text-align:center; margin-top:24px; font-size:11px; color:var(--text-dim); line-height:1.8; }
  .footer a { color:var(--primary); text-decoration:none; }
  .cost-badge { display:inline-block; background:rgba(244,164,96,0.15); color:var(--guava); padding:2px 8px; border-radius:4px; font-size:12px; font-weight:600; }
  .success-box { text-align:center; padding:30px 20px; display:none; }
  .success-box .emoji { font-size:64px; margin-bottom:12px; }
  .success-box h2 { color:var(--primary); font-size:18px; margin-bottom:8px; }
  .success-box p { color:var(--text-dim); font-size:12px; line-height:1.6; }
  .success-box .tx-link { display:block; margin-top:12px; color:var(--primary); font-size:11px; word-break:break-all; }
</style>
</head>
<body>
<div class="container">
  <div id="main-flow">
    <div class="logo">üçàüõ°Ô∏è</div>
    <h1>GUAVAGUARD ASI EDITION</h1>
    <div class="subtitle">On-chain soul verification powered by $GUAVA</div>
    <div class="security-banner">üîí <strong>Security Notice</strong><br>This page runs entirely in your browser. No backend, no tracking, no cookies.<br>Verify the URL and contract addresses below before proceeding.</div>
    <div class="contract-info">üìã <strong>Contracts (Polygon Mainnet):</strong><br>SoulRegistry V2: <code>0xecfa4e769050649aeedf727193690a696f65c3fc</code> <a href="https://polygonscan.com/address/0xecfa4e769050649aeedf727193690a696f65c3fc" target="_blank" rel="noopener noreferrer" style="color:var(--primary);font-size:10px;">‚Üó Verify</a><br>$GUAVA Token: <code>0x25cBD481901990bF0ed2ff9c5F3C0d4f743AC7B8</code> <a href="https://polygonscan.com/address/0x25cBD481901990bF0ed2ff9c5F3C0d4f743AC7B8" target="_blank" rel="noopener noreferrer" style="color:var(--primary);font-size:10px;">‚Üó Verify</a><br>Cost: <strong>1,000 $GUAVA</strong> (permanently locked, not burned)</div>

    <div class="step active" id="step1">
      <div class="step-header"><div class="step-num">1</div><div class="step-title">Connect Wallet</div></div>
      <div class="step-desc">Connect your Phantom or MetaMask wallet on <strong>Polygon</strong> network.</div>
      <button class="action-btn btn-connect" id="btn-connect">Connect Wallet</button>
      <div class="wallet-info" id="wallet-info"></div>
    </div>
    <div class="step" id="step2">
      <div class="step-header"><div class="step-num">2</div><div class="step-title">Approve $GUAVA <span class="cost-badge">1,000 $GUAVA</span></div></div>
      <div class="step-desc">Approve <strong>exactly</strong> 1,000 $GUAVA to the SoulRegistry. NOT unlimited approval.</div>
      <button class="action-btn btn-approve" id="btn-approve" disabled>Approve 1,000 $GUAVA</button>
    </div>
    <div class="step" id="step3">
      <div class="step-header"><div class="step-num">3</div><div class="step-title">Register Your Soul</div></div>
      <div class="step-desc">Register your SOUL.md hash on-chain. Your agent name will be permanently recorded.</div>
      <div class="input-group"><label>SOUL.md SHA-256 Hash (0x + 64 hex chars)</label><input type="text" id="input-hash" placeholder="0x..." autocomplete="off" spellcheck="false"></div>
      <div class="input-group"><label>Agent Name (max 64 characters)</label><input type="text" id="input-name" placeholder="Your agent name" maxlength="64" autocomplete="off" spellcheck="false"></div>
      <button class="action-btn btn-register" id="btn-register" disabled>Register Soul On-Chain ‚õìÔ∏è</button>
    </div>
    <div id="status-msg"></div>
  </div>
  <div class="success-box" id="success-box">
    <div class="emoji">üçà‚õìÔ∏è‚úÖ</div>
    <h2>Soul Registered!</h2>
    <p>Your SOUL.md hash is now permanently recorded on the Polygon blockchain.<br>GuavaGuard ASI Edition is activated.</p>
    <a id="tx-link" class="tx-link" href="#" target="_blank" rel="noopener noreferrer"></a>
    <p style="margin-top:16px;">Run <code style="color:var(--primary)">guava-guard verify</code> to confirm on-chain verification.</p>
  </div>
  <div class="footer">
    <a href="https://polygonscan.com/address/0xecfa4e769050649aeedf727193690a696f65c3fc" target="_blank" rel="noopener noreferrer">SoulRegistry V2 on PolygonScan</a><br>
    Powered by $GUAVA on Polygon ¬∑ Built by <a href="https://note.com/guava_agi" target="_blank" rel="noopener noreferrer">Singularity Laboratory</a>
  </div>
</div>

<!-- ethers.js UMD ‚Äî loaded FIRST, no module, global window.ethers -->
<script src="ethers.min.js"></script>
<script>
// Verify ethers loaded
if (typeof ethers === "undefined") {
  document.getElementById("status-msg").textContent = "FATAL: ethers.js failed to load.";
  document.getElementById("status-msg").className = "status error";
  document.getElementById("status-msg").style.display = "block";
}

var POLYGON_CHAIN_ID = "0x89";
var GUAVA_TOKEN = "0x25cBD481901990bF0ed2ff9c5F3C0d4f743AC7B8";
var SOUL_REGISTRY_V2 = "0xecfa4e769050649aeedf727193690a696f65c3fc";
var REGISTRATION_COST = ethers.parseUnits("1000", 18);

var ERC20_ABI = [
  "function approve(address spender, uint256 amount) returns (bool)",
  "function allowance(address owner, address spender) view returns (uint256)",
  "function balanceOf(address account) view returns (uint256)"
];
var REGISTRY_ABI = [
  "function registerSoul(bytes32 _hash, string _agentName)",
  "function verifySoul(address _agent, bytes32 _hash) view returns (bool)",
  "function getSoul(address _agent) view returns (bytes32 currentHash, string agentName, uint256 registeredAt, uint256 lastUpdated, uint256 guavaLocked, bytes32[] hashHistory)",
  "function totalAgents() view returns (uint256)",
  "function totalGuavaLocked() view returns (uint256)"
];

var provider = null;
var signer = null;
var userAddress = null;

function setStatus(msg, type) {
  var el = document.getElementById("status-msg");
  el.className = "status " + (type || "info");
  el.textContent = msg || "";
  el.style.display = msg ? "block" : "none";
}
function setStep(n) {
  for (var i = 1; i <= 3; i++) {
    document.getElementById("step" + i).className = "step" + (i < n ? " done" : i === n ? " active" : "");
  }
}
function getWallet() {
  if (window.phantom && window.phantom.ethereum) return { p: window.phantom.ethereum, name: "Phantom" };
  if (window.ethereum) return { p: window.ethereum, name: window.ethereum.isMetaMask ? "MetaMask" : "Wallet" };
  return null;
}

async function connectWallet() {
  try {
    setStatus("Detecting wallet...", "info");
    var w = getWallet();
    if (!w) { setStatus("No wallet found. Install Phantom or MetaMask.", "error"); return; }

    await w.p.request({ method: "eth_requestAccounts" });

    try {
      await w.p.request({ method: "wallet_switchEthereumChain", params: [{ chainId: POLYGON_CHAIN_ID }] });
    } catch (e) {
      if (e.code === 4902) {
        await w.p.request({ method: "wallet_addEthereumChain", params: [{ chainId: POLYGON_CHAIN_ID, chainName: "Polygon Mainnet", nativeCurrency: { name: "POL", symbol: "POL", decimals: 18 }, rpcUrls: ["https://polygon-rpc.com"], blockExplorerUrls: ["https://polygonscan.com"] }] });
      } else throw e;
    }

    provider = new ethers.BrowserProvider(w.p);
    signer = await provider.getSigner();
    userAddress = await signer.getAddress();

    document.getElementById("wallet-info").textContent = w.name + ": " + userAddress.slice(0,6) + "..." + userAddress.slice(-4);
    document.getElementById("btn-connect").textContent = "‚úÖ Connected";
    document.getElementById("btn-connect").disabled = true;

    var guava = new ethers.Contract(GUAVA_TOKEN, ERC20_ABI, provider);
    var balance = await guava.balanceOf(userAddress);
    var balNum = Number(ethers.formatUnits(balance, 18));

    if (balance < REGISTRATION_COST) { setStatus("Insufficient $GUAVA. Have " + balNum.toLocaleString() + ", need 1,000.", "error"); return; }

    var allowance = await guava.allowance(userAddress, SOUL_REGISTRY_V2);
    if (allowance >= REGISTRATION_COST) {
      setStatus("Balance: " + balNum.toLocaleString() + " $GUAVA ‚úÖ Already approved!", "info");
      document.getElementById("btn-approve").textContent = "‚úÖ Already Approved";
      document.getElementById("btn-approve").disabled = true;
      document.getElementById("btn-register").disabled = false;
      setStep(3);
    } else {
      setStatus("Balance: " + balNum.toLocaleString() + " $GUAVA ‚úÖ", "info");
      document.getElementById("btn-approve").disabled = false;
      setStep(2);
    }

    var reg = new ethers.Contract(SOUL_REGISTRY_V2, REGISTRY_ABI, provider);
    try {
      var soul = await reg.getSoul(userAddress);
      if (soul.registeredAt > 0n) {
        setStatus("Already registered as \"" + soul.agentName + "\". Use updateSoul() to update.", "error");
        document.getElementById("btn-register").disabled = true;
        document.getElementById("btn-approve").disabled = true;
      }
    } catch(e) {}
  } catch (err) {
    setStatus("Connection failed: " + err.message, "error");
    console.error(err);
  }
}

async function approveGuava() {
  try {
    setStatus("Requesting approval for exactly 1,000 $GUAVA...", "info");
    document.getElementById("btn-approve").disabled = true;
    var guava = new ethers.Contract(GUAVA_TOKEN, ERC20_ABI, signer);
    var tx = await guava.approve(SOUL_REGISTRY_V2, REGISTRATION_COST);
    setStatus("Approval tx sent. Waiting...", "info");
    var receipt = await tx.wait();
    if (!receipt || receipt.status !== 1) throw new Error("Approval reverted.");
    setStatus("‚úÖ Approved! Now register your soul.", "success");
    document.getElementById("btn-approve").textContent = "‚úÖ Approved";
    document.getElementById("btn-register").disabled = false;
    setStep(3);
  } catch (err) {
    setStatus("Approval failed: " + err.message, "error");
    document.getElementById("btn-approve").disabled = false;
    console.error(err);
  }
}

async function registerSoul() {
  try {
    var hash = document.getElementById("input-hash").value.replace(/[^0-9a-fA-Fx]/g, "").trim();
    var name = document.getElementById("input-name").value.replace(/[\x00-\x1f\x7f]/g, "").trim().slice(0, 64);
    if (!/^0x[0-9a-fA-F]{64}$/.test(hash)) { setStatus("Invalid hash. Must be 0x + 64 hex chars.", "error"); return; }
    if (!name) { setStatus("Agent name is required.", "error"); return; }

    setStatus("Registering soul on-chain...", "info");
    document.getElementById("btn-register").disabled = true;
    var reg = new ethers.Contract(SOUL_REGISTRY_V2, REGISTRY_ABI, signer);
    var tx = await reg.registerSoul(hash, name);
    setStatus("Tx sent! Waiting...", "info");
    var receipt = await tx.wait();
    if (!receipt || receipt.status !== 1) throw new Error("Registration reverted.");

    var net = await provider.getNetwork();
    if (net.chainId !== 137n) throw new Error("Network changed during tx!");

    var verified = await reg.verifySoul(userAddress, hash);
    if (!verified) throw new Error("On-chain verification failed.");

    document.getElementById("main-flow").style.display = "none";
    document.getElementById("success-box").style.display = "block";
    var txLink = document.getElementById("tx-link");
    if (/^0x[0-9a-fA-F]{64}$/.test(receipt.hash)) {
      txLink.href = "https://polygonscan.com/tx/" + receipt.hash;
      txLink.textContent = "View on PolygonScan: " + receipt.hash;
    }
  } catch (err) {
    setStatus("Registration failed: " + err.message, "error");
    document.getElementById("btn-register").disabled = false;
    console.error(err);
  }
}

// Bind buttons
document.getElementById("btn-connect").addEventListener("click", connectWallet);
document.getElementById("btn-approve").addEventListener("click", approveGuava);
document.getElementById("btn-register").addEventListener("click", registerSoul);

// Network listeners
var w = getWallet();
if (w && w.p.on) {
  w.p.on("chainChanged", function() { setStatus("Network changed! Switch back to Polygon.", "error"); document.getElementById("btn-approve").disabled = true; document.getElementById("btn-register").disabled = true; });
  w.p.on("accountsChanged", function() { window.location.reload(); });
}
</script>
</body>
</html>
